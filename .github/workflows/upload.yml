name: 自动上传小程序体验版

# 触发条件：当你推送一个版本号标签（如 v1.2.3）时触发
on:
  push:
    tags:
      - 'v*' # 匹配以 v 开头的标签，例如 v1.0.0, v2.1.3-beta

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取你的项目代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境（小程序CI工具需要）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. 【可选】如果你用了 npm 包，需要安装依赖并构建
      # - name: Install dependencies
      #   run: npm ci
      # - name: Build project
      #   run: npm run build

      # 4. 安装微信小程序 CI 工具
      - name: Install miniprogram-ci
        run: npm install -g miniprogram-ci

      # 5. 执行上传命令
      - name: Upload to WeChat
        run: |
          # 将GitHub Secrets中存储的密钥内容，临时写入一个文件
          echo "${{ secrets.WECHAT_PRIVATE_KEY }}" > private.key
          ls -al private.key
          cat private.key | head -5
          # 执行上传命令
          miniprogram-ci upload \
            --pp ./miniprogram \                    # 项目路径，如果代码在子文件夹，请修改
            --pkp private.key \           # 私钥文件路径
            --appid "wxd92dc382e97e9364" \    # 替换为你的真实 AppID
            --uv "5.7.0" \   # 用 Git 标签名作为版本号
            --desc "CI自动构建: ${GITHUB_SHA}" # 版本描述
